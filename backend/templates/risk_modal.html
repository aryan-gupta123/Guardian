<!-- Risk Deep Dive Modal -->
<div id="riskModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
        <div class="bg-[#0a1628] rounded-2xl shadow-2xl w-full max-w-7xl max-h-[95vh] overflow-hidden border border-blue-900/50">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 sm:p-6 border-b border-blue-950/50">
                <div class="flex items-center space-x-3 sm:space-x-4 flex-1 min-w-0">
                    <div class="w-12 h-12 sm:w-16 sm:h-16 bg-blue-600/20 rounded-xl flex items-center justify-center border border-blue-500/30 flex-shrink-0">
                        <i class="fas fa-building text-blue-400 text-lg sm:text-2xl"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h2 id="companyName" class="text-xl sm:text-3xl font-bold text-white truncate">Merchant</h2>
                        <p id="companyTicker" class="text-gray-400 text-sm sm:text-lg truncate">Ticker â€¢ Segment</p>
                    </div>
                </div>
                <button onclick="closeRiskModal()" class="text-gray-400 hover:text-white transition-colors p-2 rounded-lg hover:bg-blue-950/50 flex-shrink-0">
                    <i class="fas fa-times text-xl sm:text-2xl"></i>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="relative flex flex-col lg:flex-row h-[calc(95vh-120px)]">
                <!-- Main Content -->
                <div class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
                    <!-- Company Summary Section -->
                    <div class="mb-8">
                        <div class="bg-gradient-to-br from-blue-950/40 to-purple-950/40 border border-blue-900/30 rounded-2xl p-8 backdrop-blur-sm">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center space-x-6">
                                    <div class="w-20 h-20 bg-blue-600/20 rounded-2xl flex items-center justify-center border border-blue-500/30">
                                        <i class="fas fa-building text-blue-400 text-3xl"></i>
                                    </div>
                                    <div>
                                        <h3 id="summaryName" class="text-2xl font-bold text-white mb-2">Merchant Overview</h3>
                                        <div class="flex items-center space-x-4">
                                            <span id="summaryTicker" class="text-gray-400">Ticker</span>
                                            <span id="summaryBadge" class="bg-blue-600/20 text-blue-400 px-3 py-1 rounded-full text-sm border border-blue-500/30">Segment</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <span class="text-gray-400">Trend:</span>
                                        <span id="riskTrend" class="text-red-400 flex items-center">
                                            <i class="fas fa-arrow-up mr-1"></i>Rising
                                        </span>
                                    </div>
                                    <div class="text-4xl font-bold text-white mb-2">
                                        <span id="riskScore">72</span>/100
                                    </div>
                                    <div id="riskLevel" class="text-lg text-yellow-400 font-semibold">Moderate Risk</div>
                                    <div id="modelScoreInfo" class="text-sm text-gray-400 mt-1 hidden">
                                        Model baseline: <span id="mlModelScore">--%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Risk Score Visualization -->
                            <div class="flex items-center justify-center">
                                <div class="w-48 h-48 relative">
                                    <svg class="w-48 h-48 transform -rotate-90" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="45" stroke="#1e3a8a" stroke-width="6" fill="none"/>
                                        <circle id="riskCircle" cx="50" cy="50" r="45" stroke="#f59e0b" stroke-width="6" 
                                                fill="none" stroke-dasharray="283" stroke-dashoffset="79" 
                                                stroke-linecap="round" class="transition-all duration-1000"/>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="text-center">
                                            <span id="riskPercentage" class="text-4xl font-bold text-white">72%</span>
                                            <div class="text-gray-400 text-sm">Risk Score</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Breakdown Section -->
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold text-white mb-6">Risk Factor Breakdown</h3>
                        <div class="space-y-4">
                            <!-- Financial Volatility -->
                            <div class="bg-blue-950/30 border border-blue-900/50 rounded-xl p-6 hover:bg-blue-950/40 transition-all cursor-pointer backdrop-blur-sm" onclick="toggleRiskDetail('financial')">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center border border-red-500/30">
                                            <i class="fas fa-chart-line text-red-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-white font-semibold text-lg">Financial Volatility</h4>
                                            <p class="text-gray-400">Cash burn, leverage, liquidity</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-6">
                                        <div class="text-right">
                                            <div class="text-white font-semibold text-lg">32%</div>
                                            <div class="text-gray-400 text-sm">Weight</div>
                                        </div>
                                        <div class="w-24 bg-gray-700 rounded-full h-3">
                                            <div class="bg-red-500 h-3 rounded-full" style="width: 82%"></div>
                                        </div>
                                        <i class="fas fa-chevron-down text-gray-400"></i>
                                    </div>
                                </div>
                                <div id="financial-detail" class="hidden mt-4 p-4 bg-gray-800/50 rounded-lg border border-gray-700/50">
                                    <p class="text-gray-300 mb-3">We lean heavily on balance sheet health because collapses such as Enron, Wirecard, and Lehman Brothers all stemmed from opaque liabilities. Elevated leverage, restated earnings, or qualified audit opinions push this weight higher, while diversified cash engines like Berkshire and Costco anchor the low-risk end.</p>
                                    <p class="text-gray-400 text-sm">Key checks: off-balance-sheet debt, negative operating cash flow, external auditor warnings.</p>
                                </div>
                            </div>

                            <!-- Social Sentiment -->
                            <div class="bg-blue-950/30 border border-blue-900/50 rounded-xl p-6 hover:bg-blue-950/40 transition-all cursor-pointer backdrop-blur-sm" onclick="toggleRiskDetail('social')">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center border border-blue-500/30">
                                            <i class="fas fa-users text-blue-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-white font-semibold text-lg">Social Sentiment</h4>
                                            <p class="text-gray-400">Press, forums, whistleblower chatter</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-6">
                                        <div class="text-right">
                                            <div class="text-white font-semibold text-lg">18%</div>
                                            <div class="text-gray-400 text-sm">Weight</div>
                                        </div>
                                        <div class="w-24 bg-gray-700 rounded-full h-3">
                                            <div class="bg-blue-500 h-3 rounded-full" style="width: 54%"></div>
                                        </div>
                                        <i class="fas fa-chevron-down text-gray-400"></i>
                                    </div>
                                </div>
                                <div id="social-detail" class="hidden mt-4 p-4 bg-gray-800/50 rounded-lg border border-gray-700/50">
                                    <p class="text-gray-300 mb-3">Crowdsourced intel is our early smoke alarm. Theranos, Luckin, and FTX all triggered skeptical threads and investigative podcasts long before regulators intervened, so we give sentiment an 18% stake. Sustained negative press, whistleblower leaks, or viral customer complaints nudge this channel upward.</p>
                                    <p class="text-gray-400 text-sm">Signals tracked: abnormal spikes in negative mentions, employee review swings, long-form investigations.</p>
                                </div>
                            </div>

                            <!-- Leadership Stability -->
                            <div class="bg-blue-950/30 border border-blue-900/50 rounded-xl p-6 hover:bg-blue-950/40 transition-all cursor-pointer backdrop-blur-sm" onclick="toggleRiskDetail('leadership')">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center border border-green-500/30">
                                            <i class="fas fa-user-tie text-green-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-white font-semibold text-lg">Leadership Stability</h4>
                                            <p class="text-gray-400">CEO turnover, governance tone</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-6">
                                        <div class="text-right">
                                            <div class="text-white font-semibold text-lg">12%</div>
                                            <div class="text-gray-400 text-sm">Weight</div>
                                        </div>
                                        <div class="w-24 bg-gray-700 rounded-full h-3">
                                            <div class="bg-green-500 h-3 rounded-full" style="width: 48%"></div>
                                        </div>
                                        <i class="fas fa-chevron-down text-gray-400"></i>
                                    </div>
                                </div>
                                <div id="leadership-detail" class="hidden mt-4 p-4 bg-gray-800/50 rounded-lg border border-gray-700/50">
                                    <p class="text-gray-300 mb-3">Leadership churn rarely sinks a franchise alone, yet charismatic frauds (Madoff, Stanford, Holmes) weaponised executive control. Our 12% weighting captures resignation streaks, related-party oversight issues, and governance red flags while acknowledging steady hands like Buffett or Visa's long-tenured bench.</p>
                                    <p class="text-gray-400 text-sm">Monitors: sudden CFO exits, dual-class voting imbalances, clusters of insider selling.</p>
                                </div>
                            </div>

                            <!-- Regulatory Risk -->
                            <div class="bg-blue-950/30 border border-blue-900/50 rounded-xl p-6 hover:bg-blue-950/40 transition-all cursor-pointer backdrop-blur-sm" onclick="toggleRiskDetail('regulatory')">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 bg-yellow-500/20 rounded-xl flex items-center justify-center border border-yellow-500/30">
                                            <i class="fas fa-gavel text-yellow-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-white font-semibold text-lg">Regulatory Risk</h4>
                                            <p class="text-gray-400">Enforcement actions, compliance posture</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-6">
                                        <div class="text-right">
                                            <div class="text-white font-semibold text-lg">28%</div>
                                            <div class="text-gray-400 text-sm">Weight</div>
                                        </div>
                                        <div class="w-24 bg-gray-700 rounded-full h-3">
                                            <div class="bg-yellow-500 h-3 rounded-full" style="width: 68%"></div>
                                        </div>
                                        <i class="fas fa-chevron-down text-gray-400"></i>
                                    </div>
                                </div>
                                <div id="regulatory-detail" class="hidden mt-4 p-4 bg-gray-800/50 rounded-lg border border-gray-700/50">
                                    <p class="text-gray-300 mb-3">Sanctions can freeze accounts overnight, so regulatory risk holds a 28% share. FTX, Wirecard, and Luckin unraveled within days of coordinated actions, whereas Visa and JPMorgan invest heavily in compliance muscle. We watch SEC comment letters, DOJ probes, FCA alerts, and sanctions lists for sudden elevation.</p>
                                    <p class="text-gray-400 text-sm">Feeds monitored: SEC/DOJ dockets, FCA + ESMA notices, FinCEN advisories.</p>
                                </div>
                            </div>

                            <!-- AI Ethics / Environmental -->
                            <div class="bg-blue-950/30 border border-blue-900/50 rounded-xl p-6 hover:bg-blue-950/40 transition-all cursor-pointer backdrop-blur-sm" onclick="toggleRiskDetail('ethics')">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center border border-purple-500/30">
                                            <i class="fas fa-leaf text-purple-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-white font-semibold text-lg">AI Ethics / Environmental</h4>
                                            <p class="text-gray-400">ESG posture, data stewardship</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-6">
                                        <div class="text-right">
                                            <div class="text-white font-semibold text-lg">10%</div>
                                            <div class="text-gray-400 text-sm">Weight</div>
                                        </div>
                                        <div class="w-24 bg-gray-700 rounded-full h-3">
                                            <div class="bg-purple-500 h-3 rounded-full" style="width: 40%"></div>
                                        </div>
                                        <i class="fas fa-chevron-down text-gray-400"></i>
                                    </div>
                                </div>
                                <div id="ethics-detail" class="hidden mt-4 p-4 bg-gray-800/50 rounded-lg border border-gray-700/50">
                                    <p class="text-gray-300 mb-3">Ethics retains a 10% footholdâ€”lower than capital metrics yet still material. Repeat data misuse or environmental controversies often foreshadow fines (see Meta in 2018), while Patagonia-level stewardship reduces downstream surprises. We track AI transparency pledges, supply-chain audits, and ESG downgrades.</p>
                                    <p class="text-gray-400 text-sm">Inputs: MSCI ESG updates, NGO reports, internal model governance attestations.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Agent Actions -->
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold text-white mb-6">AI Agent Actions</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <button data-ai-action-button="true" onclick="runAIAudit()" class="bg-blue-600/20 hover:bg-blue-600/30 text-white p-6 rounded-xl transition-all flex items-center space-x-4 border border-blue-500/30 hover:border-blue-500/50 backdrop-blur-sm">
                                <i class="fas fa-brain text-2xl text-blue-400"></i>
                                <div class="text-left">
                                    <div class="font-semibold text-lg">Run AI Audit</div>
                                    <div class="text-sm text-gray-400">Baseten/Claude evaluation</div>
                                </div>
                            </button>
                            <button data-ai-action-button="true" onclick="simulateChange()" class="bg-green-600/20 hover:bg-green-600/30 text-white p-6 rounded-xl transition-all flex items-center space-x-4 border border-green-500/30 hover:border-green-500/50 backdrop-blur-sm">
                                <i class="fas fa-magic text-2xl text-green-400"></i>
                                <div class="text-left">
                                    <div class="font-semibold text-lg">Simulate Change</div>
                                    <div class="text-sm text-gray-400">Fetch.ai scenario testing</div>
                                </div>
                            </button>
                            <button data-ai-action-button="true" onclick="exportSummary()" class="bg-purple-600/20 hover:bg-purple-600/30 text-white p-6 rounded-xl transition-all flex items-center space-x-4 border border-purple-500/30 hover:border-purple-500/50 backdrop-blur-sm">
                                <i class="fas fa-download text-2xl text-purple-400"></i>
                                <div class="text-left">
                                    <div class="font-semibold text-lg">Export Summary</div>
                                    <div class="text-sm text-gray-400">Postman API report</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="w-full lg:w-96 bg-blue-950/20 border-t lg:border-t-0 lg:border-l border-blue-900/50 p-4 sm:p-6 overflow-y-auto backdrop-blur-sm">
                    <h3 class="text-xl font-bold text-white mb-6">Real-time Feed</h3>
                    
                    <!-- Live Updates -->
                    <div class="space-y-4 mb-8">
                        <div class="bg-blue-950/30 border border-blue-900/50 rounded-xl p-4 backdrop-blur-sm">
                            <div class="flex items-start space-x-3">
                                <div class="w-10 h-10 bg-blue-500/20 rounded-full flex items-center justify-center border border-blue-500/30">
                                    <i class="fas fa-twitter text-blue-400"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-white text-sm mb-2">"Tesla's new AI chip announcement driving positive sentiment"</p>
                                    <p class="text-gray-400 text-xs">2 minutes ago</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-950/30 border border-blue-900/50 rounded-xl p-4 backdrop-blur-sm">
                            <div class="flex items-start space-x-3">
                                <div class="w-10 h-10 bg-red-500/20 rounded-full flex items-center justify-center border border-red-500/30">
                                    <i class="fas fa-newspaper text-red-400"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-white text-sm mb-2">"SEC filing reveals new regulatory inquiry"</p>
                                    <p class="text-gray-400 text-xs">15 minutes ago</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-950/30 border border-blue-900/50 rounded-xl p-4 backdrop-blur-sm">
                            <div class="flex items-start space-x-3">
                                <div class="w-10 h-10 bg-green-500/20 rounded-full flex items-center justify-center border border-green-500/30">
                                    <i class="fas fa-microphone text-green-400"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-white text-sm mb-2">"CEO interview: Sustainability roadmap update"</p>
                                    <p class="text-gray-400 text-xs">1 hour ago</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Logs -->
                    <div>
                        <h4 class="text-lg font-bold text-white mb-4">Agent Logs</h4>
                        <div class="space-y-3">
                            <div class="flex items-center space-x-3 text-sm">
                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                <span class="text-green-400">Conway API: Financial data fetched</span>
                            </div>
                            <div class="flex items-center space-x-3 text-sm">
                                <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                                <span class="text-blue-400">Bright Data: Social sentiment analyzed</span>
                            </div>
                            <div class="flex items-center space-x-3 text-sm">
                                <div class="w-2 h-2 bg-yellow-400 rounded-full"></div>
                                <span class="text-yellow-400">CodeRabbit: Leadership stability assessed</span>
                            </div>
                            <div class="flex items-center space-x-3 text-sm">
                                <div class="w-2 h-2 bg-purple-400 rounded-full"></div>
                                <span class="text-purple-400">Elastic: Regulatory filings processed</span>
                            </div>
                            <div class="flex items-center space-x-3 text-sm">
                                <div class="w-2 h-2 bg-pink-400 rounded-full"></div>
                                <span class="text-pink-400">Warp: Environmental metrics updated</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Close modal when clicking outside
document.getElementById('riskModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeRiskModal();
    }
});

// Toggle risk detail sections
function toggleRiskDetail(section) {
    const detail = document.getElementById(section + '-detail');
    if (detail) {
        detail.classList.toggle('hidden');
    }
}

// AI Agent Action functions
function runAIAudit() {
    // Simulate AI audit
    console.log('Running AI audit...');
    // Add your ML model integration here
}

function simulateChange() {
    // Simulate scenario testing
    console.log('Simulating change scenarios...');
    // Add your ML model integration here
}

function exportSummary() {
    // Export summary report
    console.log('Exporting summary...');
    // Add your ML model integration here
}

function openRiskModal(transactionId) {
    const modal = document.getElementById('riskModal');
    if (!modal) {
        console.error('Risk modal element not found.');
        return;
    }

    modal.classList.remove('hidden');

    const transaction = findTransactionById(transactionId);
    const merchantName = transaction?.merchant_name || transaction?.merchant || 'Unknown Merchant';
    const ticker = transaction?.ticker || `Transaction ${transactionId}`;
    const amount = Number(transaction?.amount) || 0;
    const hour = extractHour(transaction?.timestamp) ?? new Date().getHours();
    const isForeign = deriveIsForeign(transaction, amount);
    const userTxnRate = deriveUserTxnRate(transaction, amount);

    const nameEl = document.getElementById('companyName');
    if (nameEl) {
        nameEl.textContent = merchantName;
    }

    const tickerEl = document.getElementById('companyTicker');
    if (tickerEl) {
        tickerEl.textContent = ticker;
    }

    const transactionData = {
        id: transactionId,
        merchant: transaction?.merchant_id ?? merchantName,
        merchant_id: transaction?.merchant_id ?? null,
        merchant_name: merchantName,
        amount,
        hour,
        is_foreign: isForeign,
        user_txn_rate: userTxnRate,
        features: {
            amount,
            hour,
            is_foreign: isForeign,
            user_txn_rate: userTxnRate
        }
    };

    updateRiskScoreWithML(transactionData);
}

function findTransactionById(transactionId) {
    const idAsString = String(transactionId);

    if (window.transactionCache && window.transactionCache[idAsString]) {
        return window.transactionCache[idAsString];
    }

    if (window.transactionCache && window.transactionCache[transactionId]) {
        return window.transactionCache[transactionId];
    }

    if (Array.isArray(window.transactions)) {
        const match = window.transactions.find(
            txn => String(txn.id) === idAsString
        );
        if (match) {
            return match;
        }
    }

    const element = document.querySelector(`[data-transaction-id="${idAsString}"]`);
    if (element && element.dataset.transaction) {
        try {
            return JSON.parse(element.dataset.transaction);
        } catch (error) {
            console.error('Failed to parse transaction dataset for', transactionId, error);
        }
    }

    console.warn('Transaction data not found for id:', transactionId);
    return null;
}

function extractHour(timestamp) {
    if (!timestamp) {
        return null;
    }

    const parsed = new Date(timestamp);
    if (!Number.isNaN(parsed.getTime())) {
        return parsed.getHours();
    }

    const timeMatch = String(timestamp).match(/(\d{1,2}):(\d{2})/);
    if (timeMatch) {
        return Number.parseInt(timeMatch[1], 10);
    }

    return null;
}

function deriveIsForeign(transaction, amount) {
    if (!Number.isNaN(Number(transaction?.is_foreign))) {
        return Number(transaction.is_foreign);
    }

    if (transaction?.features?.is_foreign !== undefined) {
        return Number(transaction.features.is_foreign);
    }

    return amount > 1000 ? 1 : 0;
}

function deriveUserTxnRate(transaction, amount) {
    if (!Number.isNaN(Number(transaction?.user_txn_rate))) {
        return Number(transaction.user_txn_rate);
    }

    if (transaction?.features?.user_txn_rate !== undefined) {
        return Number(transaction.features.user_txn_rate);
    }

    // Simple heuristic until backend provides a calculated rate.
    if (amount > 1000) {
        return 0.9;
    }
    if (amount > 100) {
        return 0.5;
    }
    return 0.2;
}

function showModalLoading() {
    const loadingOverlay = document.getElementById('modalLoading');
    if (loadingOverlay) {
        loadingOverlay.classList.remove('hidden');
    }

    const riskScore = document.getElementById('riskScore');
    if (riskScore) {
        if (!riskScore.dataset.originalSuffix) {
            const sibling = riskScore.nextSibling;
            if (sibling && sibling.nodeType === Node.TEXT_NODE) {
                riskScore.dataset.originalSuffix = sibling.textContent;
            }
        }

        riskScore.textContent = 'Loading...';

        const suffixNode = riskScore.nextSibling;
        if (suffixNode && suffixNode.nodeType === Node.TEXT_NODE) {
            suffixNode.textContent = '';
        }
    }

    const riskPercentage = document.getElementById('riskPercentage');
    if (riskPercentage) {
        riskPercentage.textContent = 'Loading...';
    }

    const riskLevel = document.getElementById('riskLevel');
    if (riskLevel) {
        riskLevel.textContent = 'Loading...';
        riskLevel.className = 'text-lg text-gray-400 font-semibold';
    }

    const modelScoreInfo = document.getElementById('modelScoreInfo');
    if (modelScoreInfo) {
        modelScoreInfo.classList.add('hidden');
    }
    const mlModelScore = document.getElementById('mlModelScore');
    if (mlModelScore) {
        mlModelScore.textContent = '--%';
    }

    const aiButtons = document.querySelectorAll('[data-ai-action-button]');
    aiButtons.forEach(button => {
        button.disabled = true;
        button.classList.add('opacity-50', 'cursor-not-allowed');
    });
}

function hideModalLoading() {
    const loadingOverlay = document.getElementById('modalLoading');
    if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
    }

    const riskScore = document.getElementById('riskScore');
    if (riskScore) {
        const suffixNode = riskScore.nextSibling;
        if (suffixNode && suffixNode.nodeType === Node.TEXT_NODE) {
            const originalSuffix = riskScore.dataset.originalSuffix || ' /100';
            suffixNode.textContent = originalSuffix;
        }
    }

    const aiButtons = document.querySelectorAll('[data-ai-action-button]');
    aiButtons.forEach(button => {
        button.disabled = false;
        button.classList.remove('opacity-50', 'cursor-not-allowed');
    });
}

// Function to update risk score using ML model
async function updateRiskScoreWithML(transactionData) {
    showModalLoading();

    const heuristicScore = calculateHeuristicRisk(transactionData);

    try {
        const response = await fetch('/api/ml-score/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(transactionData)
        });
        
        if (response.ok) {
            const data = await response.json();
            const modelScore = normalizeModelScore(data.risk_score);
            updateRiskDisplays(heuristicScore, modelScore);
            return data;
        } else {
            console.error('Failed to get ML risk score');
            updateRiskDisplays(heuristicScore, null);
            return null;
        }
    } catch (error) {
        console.error('Error calling ML API:', error);
        updateRiskDisplays(heuristicScore, null);
        return null;
    } finally {
        hideModalLoading();
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function normalizeModelScore(rawScore) {
    const numericScore = Number(rawScore);
    if (!Number.isFinite(numericScore)) {
        return null;
    }

    let score = numericScore;
    if (score > 100) {
        score *= 0.01;
    } else if (score > 0 && score <= 1) {
        score *= 100;
    }

    if (score < 0) score = 0;
    if (score > 80) score = 80;
    return score;
}

function calculateHeuristicRisk(transactionData) {
    const features = transactionData?.features || {};
    const amount = Number(features.amount ?? transactionData?.amount ?? 0) || 0;
    const hourValue = features.hour ?? transactionData?.hour;
    const hour = Number.isFinite(Number(hourValue)) ? Number(hourValue) : new Date().getHours();
    const isForeign = Number(features.is_foreign ?? transactionData?.is_foreign ?? 0) >= 0.5;
    const userTxnRate = Number(features.user_txn_rate ?? transactionData?.user_txn_rate ?? 0) || 0;
    const merchantNameRaw = transactionData?.merchant_name || transactionData?.merchant;
    const merchantName = merchantNameRaw ? String(merchantNameRaw).toLowerCase() : '';
    const baselineRisk = Number(transactionData?.base_score ?? transactionData?.risk_score ?? features.merchant_risk ?? 0);
    const riskLabel = (transactionData?.risk_label || transactionData?.risk || '').toLowerCase();

    let score = 12;

    if (Number.isFinite(baselineRisk) && baselineRisk >= 0) {
        score += baselineRisk * 55;
    }

    if (amount >= 5000) {
        score += 18;
    } else if (amount >= 2500) {
        score += 14;
    } else if (amount >= 1000) {
        score += 10;
    } else if (amount >= 500) {
        score += 6;
    } else if (amount >= 200) {
        score += 3;
    }

    if (isForeign) {
        score += 8;
    }

    if (userTxnRate >= 12) {
        score += 12;
    } else if (userTxnRate >= 6) {
        score += 8;
    } else if (userTxnRate >= 3) {
        score += 4;
    }

    if (hour <= 5 || hour >= 23) {
        score += 6;
    } else if (hour <= 7 || hour >= 21) {
        score += 4;
    }

    const riskyPatterns = ['crypto', 'casino', 'bet', 'gambling', 'dark', 'fraud'];
    if (merchantName) {
        if (riskyPatterns.some(pattern => merchantName.includes(pattern))) {
            score += 12;
        }

        const flaggedMerchants = new Set([
            'ftx',
            'theranos',
            'enron',
            'wirecard',
            'bernard madoff investment securities',
            'bernard madoff',
            'madoff',
            'lehman brothers',
            'luckin coffee',
            'satyam computer services'
        ]);
        if (flaggedMerchants.has(merchantName)) {
            score += 15;
        }
    }

    if (amount < 200 && !isForeign && userTxnRate < 3 && baselineRisk < 0.25) {
        score -= 5;
    }

    if (riskLabel === 'risky' || baselineRisk >= 0.7) {
        score = 50 + Math.random() * 30; // 50-80 range
    }

    return Math.max(8, Math.min(80, score));
}

function updateRiskDisplays(primaryScore, modelScore) {
    const boundedPrimary = Math.max(5, Math.min(80, Number(primaryScore) || 0));
    const roundedPrimary = Math.round(boundedPrimary);

    const riskScoreEl = document.getElementById('riskScore');
    if (riskScoreEl) {
        riskScoreEl.textContent = roundedPrimary;
    }

    const riskPercentageEl = document.getElementById('riskPercentage');
    if (riskPercentageEl) {
        riskPercentageEl.textContent = roundedPrimary + '%';
    }

    const riskLevelEl = document.getElementById('riskLevel');
    if (riskLevelEl) {
        let levelText = 'Low Risk';
        let levelClass = 'text-lg text-green-400 font-semibold';
        if (boundedPrimary >= 75) {
            levelText = 'High Risk';
            levelClass = 'text-lg text-red-400 font-semibold';
        } else if (boundedPrimary >= 50) {
            levelText = 'Moderate Risk';
            levelClass = 'text-lg text-yellow-400 font-semibold';
        }
        riskLevelEl.textContent = levelText;
        riskLevelEl.className = levelClass;
    }

    const circle = document.getElementById('riskCircle');
    if (circle) {
        const circumference = 2 * Math.PI * 45;
        const offset = circumference - (boundedPrimary / 100) * circumference;
        circle.style.strokeDashoffset = offset;

        if (boundedPrimary >= 75) {
            circle.style.stroke = '#ef4444';
        } else if (boundedPrimary >= 50) {
            circle.style.stroke = '#f59e0b';
        } else {
            circle.style.stroke = '#10b981';
        }
    }

    const modelWrapper = document.getElementById('modelScoreInfo');
    const modelScoreEl = document.getElementById('mlModelScore');
    if (modelWrapper && modelScoreEl) {
        if (modelScore === null || !Number.isFinite(modelScore)) {
            modelWrapper.classList.add('hidden');
        } else {
            const clampedModel = Math.max(0, Math.min(100, Number(modelScore) || 0));
            modelScoreEl.textContent = Math.round(clampedModel) + '%';
            modelWrapper.classList.remove('hidden');
        }
    }

    const trendEl = document.getElementById('riskTrend');
    if (trendEl) {
        let trendText = 'Stable';
        let trendIcon = 'fa-arrow-right';
        let trendClass = 'text-green-400';

        if (boundedPrimary >= 70) {
            trendText = 'Spiking';
            trendIcon = 'fa-arrow-up';
            trendClass = 'text-red-400';
        } else if (boundedPrimary >= 45) {
            trendText = 'Elevated';
            trendIcon = 'fa-arrow-up';
            trendClass = 'text-yellow-300';
        }

        trendEl.className = `flex items-center ${trendClass}`;
        trendEl.innerHTML = `<i class="fas ${trendIcon} mr-1"></i>${trendText}`;
    }
}
</script>
